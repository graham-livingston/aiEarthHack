from dotenv import load_dotenv
import os
import json
from openai import OpenAI



def getResponse(userSolution, searchTerm):
    example_idea = 'The answer to this ever-growing problem? An innovative, circular economy solution: E-Waste Recycling and Refurbishing centres.   Firstly, these centres could operate on a buy-back or exchange system where consumers can return their unwanted or old electronics. Companies could either offer a financial incentive or a replacement device to encourage people to use the service â€“ similar to a mobile phone trade-in scheme.  Secondly, rather than immediately resorting to recycling, devices could be assessed for refurbishing potential. Not only will this minimise waste, but it also provides a cost-effective source of restored tech products that can be sold at a lower cost, making technology more accessible to all. Refurbished electronics can serve numerous communities, schools, and organisations that are in need of affordable electronics.  Thirdly, if devices are beyond repair, the safe and efficient recycling of these electronic resources at the centres would enable valuable materials to be extracted and reused in the production of new devices. This not only minimizes waste but reduces the demand for mining new resources, thus saving energy.  Creating a network of these centres at a national or even global level would not only ensure this schemes effectiveness but also its feasibility and scalability. It is an opportunity that has the potential to create substantial economic, environmental, and societal value.   Lastly, businesses can team up with E-Waste Recycling and Refurbishing centres to ensure responsible end-of-life management of their electronic products. By taking responsibility for their products throughout their lifecycle, companies can demonstrate their commitment to sustainability and thus enhance their brand image and reputation.'

    example_response = '{\n\t"resources": [\n\t\t{\n\t\t\t"index": 1,\n\t\t\t"state": "Unwanted or Old Electronics",\n\t\t\t"description": "Electronics that are outdated, unwanted, or malfunctioning, gathered from consumers.",\n\t\t\t"citations": [{"text": "consumers can return their unwanted or old electronics", "start": 0, "end": 51}]\n\t\t},\n\t\t{\n\t\t\t"index": 3,\n\t\t\t"state": "Electronics for Assessment",\n\t\t\t"description": "Collected electronics awaiting evaluation for refurbishing or recycling.",\n\t\t\t"citations": [{"text": "devices could be assessed for refurbishing potential", "start": 52, "end": 93}]\n\t\t},\n\t\t{\n\t\t\t"index": 5,\n\t\t\t"state": "Refurbished Electronics",\n\t\t\t"description": "Electronics that have been refurbished, offering a cost-effective and environmentally friendly alternative.",\n\t\t\t"citations": [{"text": "provides a cost-effective source of restored tech products", "start": 94, "end": 147}]\n\t\t},\n\t\t{\n\t\t\t"index": 7,\n\t\t\t"state": "Sold Refurbished Electronics",\n\t\t\t"description": "Refurbished electronics sold to various communities, schools, organizations, or individuals in need of affordable tech.",\n\t\t\t"citations": [{"text": "Refurbished electronics can serve numerous communities, schools, and organisations", "start": 148, "end": 213}]\n\t\t},\n\t\t{\n\t\t\t"index": 9,\n\t\t\t"state": "Recycled Materials",\n\t\t\t"description": "Materials extracted from devices beyond repair, to be reused in new device production.",\n\t\t\t"citations": [{"text": "safe and efficient recycling of these electronic resources", "start": 214, "end": 265}]\n\t\t},\n\t\t{\n\t\t\t"index": 11,\n\t\t\t"state": "Impact Realization",\n\t\t\t"description": "Economic, environmental, and societal benefits achieved through the recycling and refurbishing process.",\n\t\t\t"citations": [{"text": "potential to create substantial economic, environmental, and societal value", "start": 266, "end": 329}]\n\t\t}\n\t],\n\t"processes": [\n\t\t{\n\t\t\t"index": 2,\n\t\t\t"description": "Collection and Exchange System",\n\t\t\t"quotes": {\n\t\t\t\t"who": "Consumers returning electronics",\n\t\t\t\t"what": "Return of unwanted or old electronics",\n\t\t\t\t"where": "Collection centers or designated exchange points",\n\t\t\t\t"citations": {\n\t\t\t\t\t"who": {"start": 330, "end": 370},\n\t\t\t\t\t"what": {"start": 371, "end": 405},\n\t\t\t\t\t"where": {"start": 406, "end": 449}\n\t\t\t\t}\n\t\t\t},\n\t\t\t"questions": {\n\t\t\t\t"how": "How is the exchange or buy-back value of electronics determined?"\n\t\t\t},\n\t\t\t"citations": ["operate on a buy-back or exchange system"]\n\t\t},\n\t\t{\n\t\t\t"index": 4,\n\t\t\t"description": "Assessment for Refurbishing or Recycling",\n\t\t\t"quotes": {\n\t\t\t\t"who": "Specialists at the centers",\n\t\t\t\t"what": "Evaluating electronics for possible refurbishing or recycling",\n\t\t\t\t"where": "At the recycling and refurbishing centers",\n\t\t\t\t"citations": {\n\t\t\t\t\t"who": {"start": 450, "end": 490},\n\t\t\t\t\t"what": {"start": 491, "end": 535},\n\t\t\t\t\t"where": {"start": 536, "end": 580}\n\t\t\t\t}\n\t\t\t},\n\t\t\t"questions": {\n\t\t\t\t"how": "What specific criteria or tests are used to assess electronics for refurbishing or recycling?"\n\t\t\t},\n\t\t\t"citations": ["devices could be assessed for refurbishing potential"]\n\t\t},\n\t\t{\n\t\t\t"index": 6,\n\t\t\t"description": "Refurbishing Process",\n\t\t\t"quotes": {\n\t\t\t\t"who": "Technicians at the centers",\n\t\t\t\t"what": "Restoring and repairing electronics to a functional state",\n\t\t\t\t"where": "In the refurbishing sections of the centers",\n\t\t\t\t"citations": {\n\t\t\t\t\t"who": {"start": 581, "end": 620},\n\t\t\t\t\t"what": {"start": 621, "end": 665},\n\t\t\t\t\t"where": {"start": 666, "end": 710}\n\t\t\t\t}\n\t\t\t},\n\t\t\t"questions": {\n\t\t\t\t"how": "What techniques and tools are used in the refurbishing process?"\n\t\t\t},\n\t\t\t"citations": ["provides a cost-effective source of restored tech products"]\n\t\t},\n\t\t{\n\t\t\t"index": 8,\n\t\t\t"description": "Selling Refurbished Products",\n\t\t\t"quotes": {\n\t\t\t\t"who": "The centers or partnering organizations",\n\t\t\t\t"what": "Distribution of refurbished electronics",\n\t\t\t\t"where": "Question: Where are the refurbished products sold?",\n\t\t\t\t"citations": {\n\t\t\t\t\t"who": {"start": 711, "end": 750},\n\t\t\t\t\t"what": {"start": 751, "end": 795},\n\t\t\t\t\t"where": {"start": 796, "end": 840}\n\t\t\t\t}\n\t\t\t},\n\t\t\t"questions": {\n\t\t\t\t"how": "How are the sales and distribution of refurbished products managed?"\n\t\t\t},\n\t\t\t"citations": ["Refurbished electronics can serve numerous communities, schools, and organisations"]\n\t\t},\n\t\t{\n\t\t\t"index": 10,\n\t\t\t"description": "Recycling of Non-repairable Devices",\n\t\t\t"quotes": {\n\t\t\t\t"who": "Recycling specialists",\n\t\t\t\t"what": "Processing and extracting valuable materials from non-repairable devices",\n\t\t\t\t"where": "At specialized recycling areas within the centers",\n\t\t\t\t"citations": {\n\t\t\t\t\t"who": {"start": 841, "end": 880},\n\t\t\t\t\t"what": {"start": 881, "end": 925},\n\t\t\t\t\t"where": {"start": 926, "end": 970}\n\t\t\t\t}\n\t\t\t},\n\t\t\t"questions": {\n\t\t\t\t"how": "What processes are involved in extracting materials from non-repairable devices?"\n\t\t\t},\n\t\t\t"citations": ["safe and efficient recycling of these electronic resources"]\n\t\t},\n\t\t{\n\t\t\t"index": 12,\n\t\t\t"description": "Business Integration and Lifecycle Management",\n\t\t\t"quotes": {\n\t\t\t\t"who": "Businesses and the centers",\n\t\t\t\t"what": "Collaboration for responsible end-of-life management of electronics",\n\t\t\t\t"where": "At the business locations and recycling centers",\n\t\t\t\t"citations": {\n\t\t\t\t\t"who": {"start": 971, "end": 1010},\n\t\t\t\t\t"what": {"start": 1011, "end": 1055},\n\t\t\t\t\t"where": {"start": 1056, "end": 1100}\n\t\t\t\t}\n\t\t\t},\n\t\t\t"questions": {\n\t\t\t\t"how": "How do businesses and centers collaborate for effective lifecycle management?"\n\t\t\t},\n\t\t\t"citations": ["businesses can team up with E-Waste Recycling and Refurbishing centres"]\n\t\t}\n\t]\n}'

    prompt = f'Analyze the following business idea according to specified rules and create a detailed JSON representation. The goal is to describe the business as a series of resource states and the processes that transform that resource. Each resource state and process should have an index which is sorted to describe a linear story that can help people understand the business.The JSON should include resource states, processes, citations, and questions where details are unclear or missing.\nBusiness Idea Description: {userSolution}\nRules for JSON Structure:\n\nresources:\n\n\tList every resource involved in the business followed by any resource that is just a change in the previous resources state.\n\n\tUse odd numbers for indexing each resource state.\n\n\tInclude a description and direct quotes from the provided text for each state.\n\n\tDetermine "start" and "end" indices for each citation, indicating the position of the quoted text.\n\nprocesses:\n\n\tDetail every process that transforms a resource from one state to another.\n\n\tUse even numbers for indexing processes.\n\n\tInclude a "quotes" section with details on "who", "what", "where", and "how" for each process.\n\nquotes:\n\n\t\twho: this should include the person or group of people who are involved in the process. If the text does not specify, do not add this field.\n\n\t\what: this should include the quote from the text that describes what the process is. If the text does not specify, do not add this field.\n\n\t\where: this should include the quote from the text describing the location where the process takes place. If the process involves moving a resource from one place to another, this should read "in transit", If the text does not specify, do not add this field.\n\n\t\how: this should include the quote from the text describing how the process is carried. If the text does not specify, do not add this field.\n\n\tIf any of the aspect is not explicitly described, do not add the field.\n\nCitations:\n\n\tProvide citations for all resources, processes and quotes if they are included in the text.\n\n\tCitations should include accurate "start" and "end" indices for the cited material.\n\n\tCitations for quotes should be a single sub-field for each quote that is available.\n\n\tCitations for processes and references should be on the same level as the description and reference the position where the concept described can be found. Again, only include citations fields for concepts that are described in the text.\n\nquestions:\n\n\tThe goal of the questions is to show what questions, that if answered, would provide the information needed to create a complete JSON representation.\n\n\tIf aspects (who, what, where, how) of a process are not clearly described, or a process or resource state is not described and thus cannot be cited, add a "questions" section at the same level as "quotes" with the field name from the field that couldnot be cited.\n\n\tFor the value of the field, include questioins that you formulate that if answered would provide the missing details.\n\nUndefined States or Processes:\n\n\tIf the text does not define a subsequent resource state for a rescource before describing another process that acts on it, or if a process is missing between state changes of a resource, create a placeholder in resources or processes in the location that was skipped.\n\n\tFrame relevant questions for these undefined processes or resource state changes that if answered could provide the full json requirements.\n\nBest Practices for Structuring the Business Idea:\n\n\tClarity and Sequential Order: Present the business idea in a clear, logical order.\n\n\tDetailing: Provide specific details about each process and resource state.\n\n\tComprehensive Descriptions: Ensure descriptions are detailed for accurate citation extraction.\n\n\tCoverage of Key Aspects: Make sure to cover who is involved, what the process entails, where it takes place, and how it is executed.\n\nHere is an example of a JSON representation of a business idea and its accompanying example business idea. Be sure to follow the same bracket and json formatting \ syntax that is in the example.\n'
    
    # positive_prompt = 'look through the following answer and return the text that conceptually displays'
    # negative_prompt = 'If the concept can not be found in the text display, null:'
    # Load the .env file
    load_dotenv()
    # Get the API key from the environment variable
    api_key = os.getenv("openai_key")
    # Initialize the client
    client = OpenAI(
        # This is the default and can be omitted
        api_key=api_key
    )

    response = client.chat.completions.create(
        messages=[
            {
                "role": "user",
                "content": f'{prompt}\nHere is an example idea and response.\nExample Idea:\n\t{example_idea}\nHere is the example response to the Example Idea\nExample Response:\n{example_response}'

            }
        ],
        model="gpt-4",
    )
    return response

def parseResponse(response):
    cleaned = response.choices[0].message.content
    return cleaned

def readJson(file):
    with open(file) as f:
        data = json.load(f)
    return data

def prompt_builder(userSolution, searchTerm):
    positive_prompt = 'look through the following answer and return the text that conceptually displays'
    negative_prompt = 'If the concept can not be found in the text display, null:'
    prompt = f'{positive_prompt} {searchTerm}, {negative_prompt} {userSolution}'
    return prompt
